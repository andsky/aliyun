###########################
# 内存与系统调试
###########################
vm.swappiness = 0                  # 尽量不使用 swap，提高响应速度
kernel.sysrq = 1                   # 开启 SysRq 紧急调试功能，可选

###########################
# 队列与连接数
###########################
net.core.somaxconn = 65535         # listen backlog 最大值
net.ipv4.tcp_max_syn_backlog = 65536 # 半连接队列，防 SYN flood
net.core.netdev_max_backlog = 32768 # 网卡接收队列
net.ipv4.tcp_max_tw_buckets = 50000  # TIME_WAIT 最大数量

###########################
# TCP 缓冲区 / 内存管理
###########################
net.ipv4.tcp_rmem = 4096 87380 16777216  # 接收缓冲：最小、默认、最大
net.ipv4.tcp_wmem = 4096 65536 16777216  # 发送缓冲：最小、默认、最大
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# TCP 内存管理（高并发长连接可调大，但需注意总内存占用）
# net.ipv4.tcp_mem = 94500000 915000000 927000000
net.ipv4.tcp_max_orphans = 3276800         # 最大孤儿 socket，防止 OOM

###########################
# TCP 行为与长连接优化
###########################
net.ipv4.tcp_fin_timeout = 30           # FIN_WAIT2 状态超时时间
net.ipv4.tcp_keepalive_time = 1200      # KeepAlive 探测间隔 (秒)
net.ipv4.tcp_syncookies = 1             # 防 SYN Flood
net.ipv4.tcp_tw_reuse = 1               # 允许复用 TIME_WAIT
# net.ipv4.tcp_tw_recycle = 0           # ⚠️ 禁止，NAT 环境会掉线
net.ipv4.tcp_slow_start_after_idle = 0  # 空闲后不慢启动，提高长连接带宽利用率
net.ipv4.tcp_timestamps = 1             # 关闭 TCP 时间戳，减少开销
net.ipv4.tcp_synack_retries = 2         # SYN+ACK 重试次数
net.ipv4.tcp_syn_retries = 2            # SYN 重试次数（客户端发起）

###########################
# 本地端口范围
###########################
net.ipv4.ip_local_port_range = 1024 65000  # 临时端口池

###########################
# ARP / 网络邻居表
###########################
net.ipv4.neigh.default.gc_stale_time = 120  # ARP/邻居条目超时清理
net.ipv4.conf.all.rp_filter = 0             # 关闭反向路径过滤，适合 NAT/多网卡
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.default.arp_announce = 2      # 多网卡 ARP 源 IP 策略
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_announce = 2

###########################
# 可选参数（根据内存大小可调）
###########################
# net.ipv4.tcp_mem = 94500000 915000000 927000000
# net.core.rmem_default = 8388608
# net.core.wmem_default = 8388608
